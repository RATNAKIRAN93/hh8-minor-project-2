<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PacketVoyager Intelligence | Cyber Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #010413;
            --accent-cyan: #22d3ee;
            --accent-emerald: #10b981;
            --accent-violet: #8b5cf6;
            --glass-bg: rgba(2, 6, 23, 0.7);
            --glass-border: rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 5% 5%, rgba(34, 211, 238, 0.05) 0%, transparent 35%),
                radial-gradient(circle at 95% 95%, rgba(139, 92, 246, 0.05) 0%, transparent 35%);
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }

        .packet-row {
            transition: all 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .packet-row:hover {
            background: rgba(34, 211, 238, 0.03);
            transform: scale(1.002);
        }

        .protocol-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .bg-http {
            background: #10b981;
            color: white;
        }

        .bg-https {
            background: #f59e0b;
            color: white;
        }

        .bg-dns {
            background: #818cf8;
            color: white;
        }

        .bg-tcp {
            background: #0ea5e9;
            color: white;
        }

        .bg-udp {
            background: #db2777;
            color: white;
        }

        .bg-icmp {
            background: #64748b;
            color: white;
        }

        .bg-other {
            background: #334155;
            color: white;
        }

        .radar {
            width: 44px;
            height: 44px;
            background: rgba(34, 211, 238, 0.05);
            border-radius: 50%;
            position: relative;
            border: 1px solid rgba(34, 211, 238, 0.2);
        }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--accent-cyan);
            animation: sweep 2s infinite ease-out;
        }

        @keyframes sweep {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(3);
            }
        }

        .glow-text {
            text-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(34, 211, 238, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 4s linear infinite;
            z-index: 5;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                top: 0;
            }

            100% {
                top: 100%;
            }
        }
    </style>
</head>

<body class="flex flex-col">
    <!-- Analysis Bar -->
    <header class="h-20 glass flex items-center justify-between px-10 z-50 border-b border-white/5">
        <div class="flex items-center gap-5">
            <div class="radar" id="mainRadar">
                <div class="absolute inset-0 m-auto w-2 h-2 bg-cyan-400 rounded-full"></div>
                <div class="radar-sweep hidden" id="radarSweep"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold glow-text tracking-tighter flex items-center gap-2">
                    VOYAGER<span class="text-cyan-400">ANALYSIS</span>
                    <span
                        class="text-[0.6rem] bg-cyan-500/10 text-cyan-400 px-2 py-0.5 rounded border border-cyan-500/20">CORE
                        MOD v3.0</span>
                </h1>
                <div class="flex items-center gap-3 text-[0.6rem] font-bold text-slate-500">
                    <span id="statusLabel">SYSTEM IDLE</span>
                    <span class="h-3 w-[1px] bg-white/10"></span>
                    <span id="ppsValue">0 PPS</span>
                    <span class="h-3 w-[1px] bg-white/10"></span>
                    <span id="bpsValue">0.0 KB/s</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-8">
            <div class="flex flex-col items-end">
                <span class="text-[0.6rem] text-slate-500 uppercase font-bold tracking-widest mb-1">Observation
                    Hub</span>
                <select id="interfaceSelect"
                    class="bg-transparent text-sm font-bold text-cyan-300 outline-none cursor-pointer">
                    <option value="Default">AUTO-DETECT</option>
                </select>
            </div>

            <div class="flex gap-3">
                <button id="startBtn"
                    class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold text-[0.7rem] py-2 px-8 rounded-full transition-all shadow-lg shadow-cyan-500/20">INITIATE
                    DISSECTION</button>
                <button id="stopBtn"
                    class="bg-rose-600 hover:bg-rose-500 text-white font-bold text-[0.7rem] py-2 px-8 rounded-full hidden transition-all">TERMINATE
                    ACTION</button>
                <button id="simBtn"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-bold text-[0.7rem] py-2 px-4 rounded-full transition-all border border-white/20">TEST</button>
            </div>
        </div>
    </header>


    <main class="flex-grow flex p-4 gap-4 overflow-hidden">
        <!-- Sidebar: Advanced Metrics -->
        <aside class="w-80 flex flex-col gap-4">
            <!-- Throughput Chart -->
            <div class="glass p-5 rounded-3xl h-48 flex flex-col">
                <p class="text-[0.6rem] text-slate-500 uppercase font-black mb-2 opacity-60">Network Pulse (Throughput)
                </p>
                <div class="flex-grow">
                    <canvas id="pulseChart"></canvas>
                </div>
            </div>

            <!-- Counters -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass p-5 rounded-3xl">
                    <p class="text-[0.6rem] text-slate-500 uppercase font-black mb-1 opacity-60">Total Signal</p>
                    <h3 id="statTotalPackets" class="text-2xl font-bold tracking-tighter">000</h3>
                </div>
                <div class="glass p-5 rounded-3xl">
                    <p class="text-[0.6rem] text-slate-500 uppercase font-black mb-1 opacity-60">Unique Nodes</p>
                    <h3 id="statUniqueHosts" class="text-2xl font-bold tracking-tighter">0</h3>
                </div>
            </div>

            <!-- Protocol Intelligence -->
            <div class="glass p-5 rounded-3xl flex-grow flex flex-col overflow-hidden">
                <p class="text-[0.6rem] text-slate-500 uppercase font-black mb-4 opacity-60">Distribution Density</p>
                <div class="space-y-4 overflow-y-auto pr-2" id="protocolDist">
                    <!-- Protocol rows -->
                    <div class="protocol-item">
                        <div class="flex justify-between text-[0.65rem] mb-1 font-bold">
                            <span class="text-emerald-400 uppercase">HTTP</span>
                            <span id="p-HTTP" class="font-mono text-slate-400">0</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div id="bar-HTTP" class="h-full bg-emerald-500 transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="protocol-item">
                        <div class="flex justify-between text-[0.65rem] mb-1 font-bold">
                            <span class="text-amber-500 uppercase">HTTPS</span>
                            <span id="p-HTTPS" class="font-mono text-slate-400">0</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div id="bar-HTTPS" class="h-full bg-amber-500 transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="protocol-item">
                        <div class="flex justify-between text-[0.65rem] mb-1 font-bold">
                            <span class="text-indigo-400 uppercase">DNS</span>
                            <span id="p-DNS" class="font-mono text-slate-400">0</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div id="bar-DNS" class="h-full bg-indigo-500 transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="protocol-item">
                        <div class="flex justify-between text-[0.65rem] mb-1 font-bold">
                            <span class="text-cyan-400 uppercase">TCP</span>
                            <span id="p-TCP" class="font-mono text-slate-400">0</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div id="bar-TCP" class="h-full bg-cyan-500 transition-all duration-300" style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <div class="protocol-item">
                        <div class="flex justify-between text-[0.65rem] mb-1 font-bold text-pink-400">
                            <span class="uppercase">UDP</span>
                            <span id="p-UDP" class="font-mono text-slate-400">0</span>
                        </div>
                        <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                            <div id="bar-UDP" class="h-full bg-pink-500 transition-all duration-300" style="width: 0%">
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-[0.6rem] text-slate-500 uppercase font-black mt-8 mb-4 opacity-60">Top Active Nodes</p>
                <div id="topNodes" class="space-y-3">
                    <!-- Nodes -->
                    <div class="flex justify-between text-[0.7rem] opacity-20 italic">AWAITING INTEL...</div>
                </div>
            </div>
        </aside>

        <!-- Main Stream Dissector -->
        <section class="flex-grow flex flex-col glass rounded-[2.5rem] relative overflow-hidden">
            <div class="scanline"></div>

            <div class="p-6 border-b border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <h2 class="text-xs font-bold tracking-widest uppercase opacity-80 flex items-center gap-2">
                        <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
                        Signal Stream Dissection
                    </h2>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="filterInput" placeholder="TARGET HUB ESCROW..."
                        class="bg-white/5 border border-white/10 rounded-full px-5 py-1.5 text-[0.65rem] outline-none focus:border-cyan-500 w-64 transition-all">
                    <button id="clearBtn"
                        class="text-[0.6rem] text-slate-500 hover:text-white transition-colors bg-white/10 px-5 rounded-full uppercase font-bold">Purge
                        Feed</button>
                    <button id="pcapBtn"
                        class="text-[0.6rem] text-cyan-400 hover:text-white transition-colors bg-cyan-500/10 border border-cyan-500/30 px-5 rounded-full uppercase font-bold">PCAP</button>
                </div>
            </div>

            <div class="overflow-y-auto flex-grow px-2" id="packetTableContainer">
                <table class="w-full text-left border-separate border-spacing-y-1.5 px-4">
                    <thead>
                        <tr
                            class="text-slate-500 text-[0.6rem] font-black uppercase tracking-widest sticky top-0 bg-slate-900/90 backdrop-blur z-20">
                            <th class="p-4 rounded-l-2xl">Time Vector</th>
                            <th class="p-4 text-center">Class</th>
                            <th class="p-4">Operational Context</th>
                            <th class="p-4">Origin Node</th>
                            <th class="p-4">Terminal Node</th>
                            <th class="p-4 text-center">Threat Vector</th>
                            <th class="p-4 rounded-r-2xl">Forensic Payload</th>
                        </tr>
                    </thead>
                    <tbody id="packetList" class="font-['JetBrains_Mono'] pt-2">
                        <!-- Dissected Packets -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Forensic Hub -->
        <aside class="w-96 glass rounded-[2.5rem] p-7 flex flex-col gap-6" id="forensicHub">
            <div>
                <h2
                    class="text-[0.6rem] text-slate-500 uppercase font-black mb-6 flex items-center gap-2 tracking-[0.2em] opacity-80">
                    <svg class="w-3 h-3 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A10.003 10.003 0 0014 3.118a10.003 10.003 0 00-4.144 13.912" />
                    </svg>
                    Intelligence Inspector
                </h2>

                <div id="inspectorHint" class="text-center py-48 opacity-10">
                    <p class="text-[0.6rem] italic uppercase tracking-[0.3em]">Select Stream Element</p>
                </div>

                <div id="detailsArea" class="hidden animate-in fade-in duration-500">
                    <div id="activeProtocolBadge" class="protocol-badge mb-6 px-4 py-1.5 shadow-lg shadow-black/40">
                    </div>

                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 flex-grow">
                                <p class="text-[0.45rem] text-slate-500 uppercase font-black mb-1">Service Intelligence
                                </p>
                                <p id="detService" class="text-xs font-bold text-cyan-400 tracking-tight uppercase"></p>
                            </div>
                            <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 flex-grow">
                                <p class="text-[0.45rem] text-slate-500 uppercase font-black mb-1">Risk Assessment</p>
                                <div id="detRiskBadge" class="inline-block mt-0.5"></div>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                            <p class="text-[0.5rem] text-slate-500 uppercase font-black mb-1">Internal Risk Signature
                            </p>
                            <p id="detRiskText" class="text-xs font-medium text-slate-400"></p>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                            <p class="text-[0.5rem] text-slate-500 uppercase font-black mb-1">Source Interface</p>
                            <p id="detSrc" class="text-sm font-bold text-slate-300 tracking-tight"></p>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                            <p class="text-[0.5rem] text-slate-500 uppercase font-black mb-1">Destination Interface</p>
                            <p id="detDst" class="text-sm font-bold text-slate-300 tracking-tight"></p>
                        </div>
                        <div class="relative">
                            <div
                                class="absolute -top-2 -right-2 text-[0.5rem] glass px-2 py-0.5 rounded text-cyan-400 border border-cyan-500/30">
                                RAW_PAYLOAD</div>
                            <div class="bg-slate-950/80 p-5 rounded-2xl font-mono text-[0.7rem] break-all leading-relaxed text-slate-300 border border-white/5 h-64 overflow-y-auto shadow-inner"
                                id="detPayload">
                                <!-- Detailed Intel -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <footer class="h-10 px-10 flex items-center justify-between text-[0.6rem] text-slate-600 bg-white/5">
        <div>CORE ANALYTICS <span class="text-cyan-600 px-1">//</span> SCAPY-VOYAGER INTELLIGENCE <span
                class="text-cyan-600 px-1">//</span> <span id="currentTime">00:00:00</span></div>
        <div class="flex items-center gap-6">
            <span class="flex items-center gap-1.5 font-bold uppercase"><span
                    class="w-1.5 h-1.5 bg-cyan-700 rounded-full"></span> MISSION STATUS: ACTIVE</span>
            <span class="text-slate-700">|</span>
            <span class="text-cyan-800">C:\\SENSORS\\NET_IFACE</span>
        </div>
    </footer>

    <script>
        const socket = io();
        let pulseChart;

        // Elements
        const packetList = document.getElementById('packetList');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusLabel = document.getElementById('statusLabel');
        const radarSweep = document.getElementById('radarSweep');

        // Stats elements
        const statTotalPackets = document.getElementById('statTotalPackets');
        const statUniqueHosts = document.getElementById('statUniqueHosts');
        const ppsValue = document.getElementById('ppsValue');
        const bpsValue = document.getElementById('bpsValue');
        const topNodes = document.getElementById('topNodes');

        // Create Log Container
        const logContainer = document.createElement('div');
        logContainer.style.cssText = 'position:fixed; bottom:10px; right:10px; width:300px; height:150px; background:rgba(0,0,0,0.8); color:#0f0; font-family:monospace; font-size:10px; overflow-y:scroll; z-index:9999; padding:5px; border:1px solid #333; pointer-events:none; opacity:0.7;';
        document.body.appendChild(logContainer);

        function log(msg) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(msg);
        }

        socket.on('connect', () => {
            log('Connected to server');
            statusLabel.textContent = "SYSTEM CONNECTED";
            socket.emit('get_status'); // Check if already running
        });

        socket.on('disconnect', () => {
            log('Disconnected from server');
            statusLabel.textContent = "SYSTEM DISCONNECTED";
        });

        socket.on('connect_error', (error) => {
            log('Connection Error: ' + error);
        });

        // Initialize Pulse Chart
        function initChart() {
            const ctx = document.getElementById('pulseChart').getContext('2d');
            pulseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        label: 'Bps',
                        data: Array(20).fill(0),
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#475569', font: { size: 9 } } }
                    },
                    animation: { duration: 500 }
                }
            });
        }

        initChart();

        // Clock
        setInterval(() => {
            document.getElementById('currentTime').innerText = new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        fetch('/interfaces').then(r => r.json()).then(data => {
            log(`Loaded ${data.length} interfaces`);
            const select = document.getElementById('interfaceSelect');
            select.innerHTML = ''; // Clear previous

            // Add 'Default' option first
            const defaultOpt = document.createElement('option');
            defaultOpt.value = 'Default';
            defaultOpt.textContent = 'AUTO-DETECT';
            select.appendChild(defaultOpt);

            data.forEach(iface => {
                const opt = document.createElement('option');
                opt.value = iface.id; // Use the interface ID/Name for sniffing
                opt.textContent = iface.name.toUpperCase();
                select.appendChild(opt);
            });
        }).catch(e => log('Error loading interfaces: ' + e));

        startBtn.onclick = () => {
            log('Start sniffing requested...');
            const iface = document.getElementById('interfaceSelect').value;
            socket.emit('start_sniffing', { interface: iface });
        };

        stopBtn.onclick = () => {
            log('Stop sniffing requested...');
            socket.emit('stop_sniffing');
        };

        document.getElementById('clearBtn').onclick = () => {
            packetList.innerHTML = '';
            log('Feed cleared');
        };

        socket.on('status', (data) => {
            log(`Status update: ${data.status}`);
            if (data.status === 'running') {
                statusLabel.innerText = 'DISSECTION OPERATIONAL';
                statusLabel.classList.add('text-cyan-400');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                radarSweep.classList.remove('hidden');
            } else {
                statusLabel.innerText = 'SYSTEM STASIS';
                statusLabel.classList.remove('text-cyan-400');
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                radarSweep.classList.add('hidden');
            }
        });

        socket.on('error', (data) => {
            log(`ERROR: ${data.message}`);
            alert(`Error: ${data.message}`);
        });

        function processPacket(packet) {
            // Only log randomly to avoid spam
            if (Math.random() < 0.01) log(`Processing packet ID: ${packet.id}`);

            const filter = document.getElementById('filterInput').value.toLowerCase();
            const searchStr = `${packet.protocol} ${packet.src} ${packet.dst} ${packet.info} ${packet.service} ${packet.risk}`.toLowerCase();
            if (filter && !searchStr.includes(filter)) return;

            const row = document.createElement('tr');
            row.className = 'packet-row cursor-pointer';

            const proto = packet.protocol.toUpperCase();
            let pClass = 'bg-other';
            if (proto.includes('HTTP')) pClass = 'bg-http';
            if (proto.includes('HTTPS')) pClass = 'bg-https';
            if (proto.includes('DNS')) pClass = 'bg-dns';
            if (proto === 'TCP') pClass = 'bg-tcp';
            if (proto === 'UDP') pClass = 'bg-udp';
            if (proto === 'ICMP') pClass = 'bg-icmp';

            row.innerHTML = `
                <td class="p-4 text-[0.6rem] text-slate-500 font-mono">${packet.timestamp}</td>
                <td class="p-4 text-center"><span class="protocol-badge ${pClass}">${packet.protocol}</span></td>
                <td class="p-4"><span class="text-[0.65rem] text-cyan-400 font-black tracking-wider uppercase bg-cyan-400/5 px-2 py-1 rounded border border-cyan-500/10">${packet.service}</span></td>
                <td class="p-4 text-[0.65rem] font-bold text-slate-400 opacity-80 uppercase">${packet.src}</td>
                <td class="p-4 text-[0.65rem] font-bold text-slate-400 opacity-80 uppercase">${packet.dst}</td>
                <td class="p-4 text-center">
                    <span class="px-2 py-0.5 rounded text-[0.55rem] font-black border ${packet.risk === 'CRITICAL' ? 'bg-rose-500/20 text-rose-500 border-rose-500/30' : packet.risk === 'WARN' ? 'bg-amber-500/20 text-amber-500 border-amber-500/30' : 'bg-emerald-500/10 text-emerald-300 border-emerald-500/20'}">
                        ${packet.risk}
                    </span>
                </td>
                <td class="p-4 text-[0.7rem] text-slate-300 truncate max-w-[200px] font-medium" title="${packet.info}">${packet.info}</td>
            `;

            row.onclick = () => showInspector(packet);
            packetList.insertBefore(row, packetList.firstChild);

            if (packetList.children.length > 100) packetList.removeChild(packetList.lastChild);
        }

        socket.on('new_packet', (packet) => {
            processPacket(packet);
        });

        socket.on('new_batch', (batch) => {
            batch.forEach(packet => processPacket(packet));
        });

        function showInspector(packet) {
            document.getElementById('inspectorHint').classList.add('hidden');
            document.getElementById('detailsArea').classList.remove('hidden');
            document.getElementById('detSrc').innerText = packet.src;
            document.getElementById('detDst').innerText = packet.dst;
            document.getElementById('detPayload').innerText = packet.info;
            document.getElementById('detService').innerText = packet.service;
            document.getElementById('detRiskText').innerText = packet.risk_desc;

            const riskBadge = document.getElementById('detRiskBadge');
            riskBadge.innerText = packet.risk;
            riskBadge.className = 'px-3 py-1 rounded-full text-[0.6rem] font-black border ' +
                (packet.risk === 'CRITICAL' ? 'bg-rose-500/20 text-rose-500 border-rose-500/30' :
                    packet.risk === 'WARN' ? 'bg-amber-500/20 text-amber-500 border-amber-500/30' :
                        'bg-emerald-500/10 text-emerald-300 border-emerald-500/20');

            const badge = document.getElementById('activeProtocolBadge');
            badge.innerText = packet.protocol;
            badge.className = 'protocol-badge ' + (packet.protocol.includes('HTTP') ? 'bg-http' :
                packet.protocol.includes('HTTPS') ? 'bg-https' :
                    packet.protocol.includes('DNS') ? 'bg-dns' :
                        packet.protocol === 'TCP' ? 'bg-tcp' : 'bg-udp');
        }

        socket.on('update_stats', (stats) => {
            statTotalPackets.innerText = stats.packet_count.toString().padStart(4, '0');
            statUniqueHosts.innerText = stats.unique_hosts;
            ppsValue.innerText = `${stats.pps} PPS`;

            const kb = (stats.bps / 1024).toFixed(1);
            bpsValue.innerText = `${kb} KB/s`;

            // Update Chart
            if (stats.history && stats.history.length > 0) {
                pulseChart.data.labels = stats.history.map(h => h.t);
                pulseChart.data.datasets[0].data = stats.history.map(h => h.bps);
                pulseChart.update('none');
            }

            // Protocol Distribution
            const total = Object.values(stats.protocols).reduce((a, b) => a + b, 0);
            for (const [proto, count] of Object.entries(stats.protocols)) {
                const bar = document.getElementById(`bar-${proto}`);
                const countEl = document.getElementById(`p-${proto}`);
                if (bar && countEl) {
                    countEl.innerText = count;
                    bar.style.width = total > 0 ? (count / total * 100) + '%' : '0%';
                }
            }

            // Update Top Nodes Leaderboard
            if (stats.top_ips) {
                const sorted = Object.entries(stats.top_ips).sort((a, b) => b[1] - a[1]).slice(0, 4);
                topNodes.innerHTML = sorted.map(([ip, count]) => `
                    <div class="flex justify-between items-center text-[0.65rem] bg-white/5 p-2 rounded-lg border border-white/5">
                        <span class="font-bold text-slate-300 font-mono truncate w-32">${ip}</span>
                        <span class="bg-cyan-500/10 text-cyan-400 px-2 rounded font-black">${count} PKTS</span>
                    </div>
                `).join('');
            }
        });

        // Download PCAP
        document.getElementById('pcapBtn').onclick = () => {
            log('Downloading PCAP...');
            window.location.href = '/download_pcap';
        };

        // Simulate Packet
        document.getElementById('simBtn').onclick = () => {
            log('Sending simulation request...');
            fetch('/simulate_packet').then(r => log('Sim sent')).catch(e => log('Sim failed: ' + e));
        };
    </script>
</body>

</html>